<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘é‡æœå°‹ä»‹é¢ç¯„ä¾‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
    }
    button {
      padding: 12px 24px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover {
      background-color: #2563eb;
    }
    button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    .answer-container {
      margin-top: 20px;
      padding: 20px;
      background-color: #f9fafb;
      border-radius: 6px;
      min-height: 100px;
    }
    .answer {
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
    }
    .loading {
      color: #6b7280;
      font-style: italic;
    }
    .error {
      color: #dc2626;
      padding: 10px;
      background-color: #fee2e2;
      border-radius: 4px;
      margin-top: 10px;
    }
    .config-section {
      background-color: #eff6ff;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .config-section input {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” å‘é‡æœå°‹ä»‹é¢</h1>
    
    <div class="config-section">
      <label>
        <strong>Supabase å°ˆæ¡ˆ URLï¼š</strong>
        <input 
          type="text" 
          id="projectUrl" 
          placeholder="https://your-project-ref.supabase.co"
          value=""
        />
        <small>è«‹å¡«å…¥æ‚¨çš„ Supabase å°ˆæ¡ˆ URLï¼ˆä¸å«å°¾éƒ¨çš„æ–œç·šï¼‰</small>
      </label>
      <label style="margin-top: 15px; display: block;">
        <strong>Supabase Anon Keyï¼ˆå¯é¸ï¼‰ï¼š</strong>
        <input 
          type="password" 
          id="anonKey" 
          placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          value=""
        />
        <small>å¦‚æœ Edge Function éœ€è¦èªè­‰ï¼Œè«‹å¡«å…¥ Anon Keyã€‚å¯åœ¨ Supabase Dashboard > Settings > API æ‰¾åˆ°</small>
      </label>
    </div>

    <form id="searchForm" class="search-box">
      <input 
        type="text" 
        id="queryInput" 
        placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šä»€éº¼æ˜¯ Supabaseï¼Ÿ"
        required
      />
      <button type="submit" id="submitBtn">æœå°‹</button>
    </form>

    <div id="answerContainer" class="answer-container" style="display: none;">
      <div id="answer" class="answer"></div>
    </div>

    <div id="error" class="error" style="display: none;"></div>
  </div>

  <script>
    const form = document.getElementById('searchForm');
    const queryInput = document.getElementById('queryInput');
    const submitBtn = document.getElementById('submitBtn');
    const answerContainer = document.getElementById('answerContainer');
    const answerDiv = document.getElementById('answer');
    const errorDiv = document.getElementById('error');
    const projectUrlInput = document.getElementById('projectUrl');
    const anonKeyInput = document.getElementById('anonKey');

    // å¾ localStorage è¼‰å…¥ä¹‹å‰ä¿å­˜çš„è¨­å®š
    const savedUrl = localStorage.getItem('supabaseProjectUrl');
    if (savedUrl) {
      projectUrlInput.value = savedUrl;
    }
    const savedKey = localStorage.getItem('supabaseAnonKey');
    if (savedKey) {
      anonKeyInput.value = savedKey;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // éš±è—éŒ¯èª¤è¨Šæ¯
      errorDiv.style.display = 'none';
      
      // å–å¾—å°ˆæ¡ˆ URL
      const projectUrl = projectUrlInput.value.trim();
      if (!projectUrl) {
        showError('è«‹å…ˆå¡«å…¥ Supabase å°ˆæ¡ˆ URL');
        return;
      }

      // ä¿å­˜è¨­å®šåˆ° localStorage
      localStorage.setItem('supabaseProjectUrl', projectUrl);
      const anonKey = anonKeyInput.value.trim();
      if (anonKey) {
        localStorage.setItem('supabaseAnonKey', anonKey);
      }

      const query = queryInput.value.trim();
      if (!query) {
        showError('è«‹è¼¸å…¥æœå°‹å•é¡Œ');
        return;
      }

      // é‡ç½®ç­”æ¡ˆå€åŸŸ
      answerDiv.textContent = '';
      answerContainer.style.display = 'block';
      answerDiv.textContent = 'æ€è€ƒä¸­...';
      answerDiv.className = 'answer loading';
      
      // ç¦ç”¨è¡¨å–®
      submitBtn.disabled = true;
      queryInput.disabled = true;

      // æ§‹å»º Edge Function URL
      const functionUrl = `${projectUrl}/functions/v1/vector-search`;
      const queryParams = new URLSearchParams({ query });
      const fullUrl = `${functionUrl}?${queryParams.toString()}`;

      try {
        // æº–å‚™ headersï¼ˆå¦‚æœæœ‰æä¾› API keyï¼‰
        const headers = {
          'Accept': 'text/event-stream',
        };
        
        // å¦‚æœæä¾›äº† anon keyï¼ŒåŠ å…¥åˆ° headers
        if (anonKey) {
          headers['apikey'] = anonKey;
          headers['Authorization'] = `Bearer ${anonKey}`;
        }

        // ä½¿ç”¨ Fetch API ä¾†æ”¯æ´è‡ªå®šç¾© headers
        const response = await fetch(fullUrl, {
          method: 'GET',
          headers: headers,
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        // æª¢æŸ¥ Content-Type æ˜¯å¦ç‚º SSE
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('text/event-stream')) {
          // å¦‚æœä¸æ˜¯ SSEï¼Œå¯èƒ½æ˜¯éŒ¯èª¤è¨Šæ¯
          const text = await response.text();
          try {
            const json = JSON.parse(text);
            throw new Error(json.error || text);
          } catch {
            throw new Error(text || 'æœªé æœŸçš„å›æ‡‰æ ¼å¼');
          }
        }

        // ç§»é™¤è¼‰å…¥ç‹€æ…‹
        answerDiv.className = 'answer';
        answerDiv.textContent = '';

        // ä½¿ç”¨ ReadableStream ä¾†è™•ç† SSE ä¸²æµ
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          
          if (done) {
            enableForm();
            break;
          }

          // è§£ç¢¼è³‡æ–™ä¸¦åŠ å…¥ç·©è¡å€
          buffer += decoder.decode(value, { stream: true });
          
          // è™•ç†å®Œæ•´çš„ SSE è¨Šæ¯
          const lines = buffer.split('\n');
          buffer = lines.pop(); // ä¿ç•™æœ€å¾Œä¸å®Œæ•´çš„è¡Œ

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6); // ç§»é™¤ 'data: ' å‰ç¶´
              
              // æª¢æŸ¥æ˜¯å¦å®Œæˆ
              if (data.trim() === '[DONE]') {
                enableForm();
                return;
              }

              try {
                // è§£æ OpenAI å›æ‡‰
                const completionResponse = JSON.parse(data);
                
                if (completionResponse.choices && completionResponse.choices[0]) {
                  const text = completionResponse.choices[0].text || '';
                  // ç´¯åŠ æ–‡å­—å…§å®¹
                  answerDiv.textContent += text;
                }
              } catch (parseError) {
                // å¦‚æœè§£æå¤±æ•—ï¼Œå¯èƒ½æ˜¯å…¶ä»–é¡å‹çš„è¨Šæ¯
                console.log('ç„¡æ³•è§£æçš„è³‡æ–™:', data);
              }
            }
          }
        }

      } catch (error) {
        console.error('é€£ç·šéŒ¯èª¤:', error);
        answerDiv.textContent = '';
        let errorMessage = 'é€£ç·šç™¼ç”ŸéŒ¯èª¤';
        
        if (error.message) {
          errorMessage += ': ' + error.message;
        } else {
          errorMessage += 'ï¼Œè«‹æª¢æŸ¥ï¼š\n1. å°ˆæ¡ˆ URL æ˜¯å¦æ­£ç¢º\n2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\n3. Edge Function æ˜¯å¦éœ€è¦ API key';
        }
        
        showError(errorMessage);
        enableForm();
      }
    });

    function enableForm() {
      submitBtn.disabled = false;
      queryInput.disabled = false;
    }

    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }
  </script>
</body>
</html>

